name: Build and Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ–¥
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. –ó—ñ–±—Ä–∞—Ç–∏ JAR
      - name: Build JAR
        run: ./mvnw clean package -DskipTests

      # 4. [DEBUG] –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ñ–∞–π–ª—ñ–≤ —É –∫–æ—Ä–µ–Ω—ñ
      - name: Show root files
        run: ls -l

      # 5. [DEBUG] –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ñ–∞–π–ª—ñ–≤ —É target/
      - name: Show target contents
        run: ls -l target

      # 6. –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: Copy deploy files to server via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          source: |
            target
            docker-compose.yml
            Dockerfile
          target: "/root/auth-service"
          rm: false  # üîß –í–ê–ñ–õ–ò–í–û: –∑–∞–ø–æ–±—ñ–≥–∞—î –ø–æ–º–∏–ª—Ü—ñ i/o timeout

      # 7. –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            cd /root/auth-service

            # üîê –°—Ç–≤–æ—Ä—é—î–º–æ .env –∑ GitHub Secrets
            echo "SPRING_DATASOURCE_URL=${{ secrets.ENV_SPRING_DATASOURCE_URL }}" > .env
            echo "SPRING_DATASOURCE_USERNAME=${{ secrets.ENV_SPRING_DATASOURCE_USERNAME }}" >> .env
            echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.ENV_SPRING_DATASOURCE_PASSWORD }}" >> .env
            echo "JWT_SECRET=${{ secrets.ENV_JWT_SECRET }}" >> .env

            # üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            docker compose down
            docker compose up -d --build